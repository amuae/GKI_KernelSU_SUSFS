name: Build GKI Kernel (Standalone)

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version'
        required: true
        default: 'android14'
        type: choice
        options:
          - android14
          - android15
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'
          - '6.6'
      os_patch_level:
        description: 'OS Patch Level (YYYY-MM)'
        required: true
        default: '2025-01'
        type: string
      hook_method:
        description: 'Hook Method'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - syscall
          - kprobes
      module_bypass:
        description: 'Enable Module Bypass'
        required: false
        default: false
        type: boolean
      enable_bbg:
        description: 'Enable Baseband Guard (BBG)'
        required: false
        default: true
        type: boolean
      enable_ipset:
        description: 'Enable IPSet Support'
        required: false
        default: true
        type: boolean
      enable_lto:
        description: 'Enable LTO (Link Time Optimization)'
        required: false
        default: true
        type: boolean
      kernel_name:
        description: 'Custom Kernel Name Suffix'
        required: false
        default: 'gca0ef6d17716-ab13624819'
        type: string
      build_time:
        description: 'Build Time'
        required: false
        default: 'Tue Jun 10 18:59:08 UTC 2025'
        type: string

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04
    
    steps:
      - name: Setup Build Environment
        run: |
          echo "=== Setting up build environment ==="
          sudo apt-get update -qq
          sudo apt-get install -y -qq git curl wget build-essential bc bison flex libssl-dev libelf-dev zip python3 python3-pip rsync >/dev/null 2>&1
          
          # Install repo tool
          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+rx ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          
          # Force IPv4
          git config --global url."https://github.com/".insteadOf "git://github.com/"
          git config --global http.version HTTP/1.1
          
          echo "Build environment ready"
      
      - name: Download Kernel Source
        run: |
          echo "=== Downloading Kernel Source ==="
          
          # Determine sublevel
          case "${{ inputs.kernel_version }}" in
            "5.15") SUBLEVEL="119" ;;
            "6.1")  SUBLEVEL="118" ;;
            "6.6")  SUBLEVEL="65" ;;
            *)      SUBLEVEL="118" ;;
          esac
          
          FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
          SOURCE_DIR="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${SUBLEVEL}"
          
          echo "Branch: common-${FORMATTED_BRANCH}"
          echo "Source Dir: ${SOURCE_DIR}"
          
          mkdir -p "${SOURCE_DIR}"
          cd "${SOURCE_DIR}"
          
          ~/bin/repo init --depth=1 \
            --u https://android.googlesource.com/kernel/manifest \
            -b "common-${FORMATTED_BRANCH}" \
            --repo-rev=v2.16
          
          REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common "${FORMATTED_BRANCH}" 2>/dev/null || true)
          if echo "$REMOTE_BRANCH" | grep -q deprecated; then
            echo "Branch is deprecated, updating manifest..."
            sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" .repo/manifests/default.xml
          fi
          
          CPU_COUNT=$(nproc)
          echo "Syncing with ${CPU_COUNT} parallel jobs..."
          ~/bin/repo sync -c -j"${CPU_COUNT}" --no-tags --fail-fast
          
          if [ -f "common/Makefile" ]; then
            ACTUAL_SUBLEVEL=$(grep '^SUBLEVEL = ' common/Makefile | awk '{print $3}' || echo "${SUBLEVEL}")
            if [ -n "$ACTUAL_SUBLEVEL" ]; then
              SUBLEVEL="$ACTUAL_SUBLEVEL"
            fi
          fi
          
          echo "Kernel version: ${{ inputs.kernel_version }}.${SUBLEVEL}"
          cd ..
          
          echo "SOURCE_DIR=${SOURCE_DIR}" >> $GITHUB_ENV
          echo "SUBLEVEL=${SUBLEVEL}" >> $GITHUB_ENV
      
      - name: Setup KernelSU
        run: |
          echo "=== Adding KernelSU ==="
          cd "${{ env.SOURCE_DIR }}"
          
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s susfs-main
          
          cd ./KernelSU
          
          GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
          echo "Current commit hash: $GIT_COMMIT_HASH"
          
          KSU_API_VERSION=""
          for i in {1..3}; do
            KSU_API_VERSION=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/Makefile" | \
              grep -m1 "KSU_VERSION_API :=" | \
              awk -F'= ' '{print $2}' | \
              tr -d '[:space:]' || echo "")
            if [ -n "$KSU_API_VERSION" ]; then
              break
            fi
            sleep 1
          done
          
          if [ -z "$KSU_API_VERSION" ]; then
            KSU_API_VERSION="3.1.7"
            echo "[WARN] Cannot fetch remote API version, using default: $KSU_API_VERSION"
          else
            echo "[OK] KSU API version: $KSU_API_VERSION"
          fi
          
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile || true
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile || true
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile || true
          
          echo "" >> kernel/Makefile
          echo "define get_ksu_version_full" >> kernel/Makefile
          echo "v\$1-${GIT_COMMIT_HASH}@main_test" >> kernel/Makefile
          echo "endef" >> kernel/Makefile
          echo "" >> kernel/Makefile
          echo "KSU_VERSION_API := ${KSU_API_VERSION}" >> kernel/Makefile
          echo "KSU_VERSION_FULL := v${KSU_API_VERSION}-${GIT_COMMIT_HASH}@main_test" >> kernel/Makefile
          
          KSU_VERSION=$(git rev-list --count main 2>/dev/null || echo 0)
          if [ "$KSU_VERSION" != "0" ]; then
            KSU_VERSION=$((KSU_VERSION + 37185))
          else
            KSU_VERSION=114514
          fi
          echo "[OK] KSU version number: $KSU_VERSION"
          echo "[OK] SukiSU version: v${KSU_API_VERSION}-${GIT_COMMIT_HASH}@main_test"
          
          cd ..
      
      - name: Apply SUSFS Patches
        run: |
          echo "=== Applying KernelSU & SUSFS Patches ==="
          cd "${{ env.SOURCE_DIR }}"
          
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./common/
          cp -r ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp -r ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          
          cd common
          patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
          
          if [ "${{ inputs.hook_method }}" == "manual" ]; then
            echo "Applying manual hooks patch..."
            cp ../SukiSU_patch/hooks/scope_min_manual_hooks_v1.6.patch ./
            patch -p1 -F 3 < scope_min_manual_hooks_v1.6.patch || true
          elif [ "${{ inputs.hook_method }}" == "syscall" ]; then
            echo "Applying syscall hooks patch..."
            cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
            patch -p1 -F 3 < syscall_hooks.patch || true
          fi
          
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch || true
          
          cd ..
      
      - name: Apply Extra Patches
        run: |
          echo "=== Applying Extra Patches ==="
          cd "${{ env.SOURCE_DIR }}/common"
          
          wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/other_patch/config.patch || true
          if [ -f "config.patch" ]; then
            patch -p1 -F 3 < config.patch || true
            echo "[OK] config.patch applied"
          fi
          
          cd ..
          
          if [ "${{ inputs.enable_bbg }}" = "true" ]; then
            echo "=== Adding Baseband Guard (BBG) ==="
            wget -q -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash 2>&1 | grep -v "awk:" || true
            echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
            echo "BBG configured successfully"
          fi
      
      - name: Configure Kernel
        run: |
          echo "=== Configuring Kernel ==="
          cd "${{ env.SOURCE_DIR }}"
          
          DEFCONFIG="./common/arch/arm64/configs/gki_defconfig"
          
          sed -i 's/check_defconfig//' ./common/build.config.gki
          
          echo "Adding kernel configurations..."
          
          # KernelSU Configuration
          echo "" >> "$DEFCONFIG"
          echo "# KernelSU Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU=y" >> "$DEFCONFIG"
          if [ "${{ inputs.hook_method }}" == "kprobes" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_MANUAL_HOOK=n" >> "$DEFCONFIG"
            echo "CONFIG_KSU_KPROBES_HOOK=y" >> "$DEFCONFIG"
          else
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> "$DEFCONFIG"
          fi
          
          # Mountify Support
          echo "" >> "$DEFCONFIG"
          echo "# Mountify Support" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_XATTR=y" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$DEFCONFIG"
          
          # Networking Configuration
          echo "" >> "$DEFCONFIG"
          echo "# Networking Configuration" >> "$DEFCONFIG"
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> "$DEFCONFIG"
          
          # IPSet Support (optional)
          if [ "${{ inputs.enable_ipset }}" = "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# IPSet Support" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_MAX=65534" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_MAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_LIST_SET=y" >> "$DEFCONFIG"
          fi
          
          # SUSFS Configuration
          echo "" >> "$DEFCONFIG"
          echo "# SUSFS Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$DEFCONFIG"
          
          # Sound Configuration
          echo "" >> "$DEFCONFIG"
          echo "# Sound Configuration" >> "$DEFCONFIG"
          echo "CONFIG_SND=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_DRIVERS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_PCM=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_TIMER=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_DYNAMIC_MINORS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_PROC_FS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_ALOOP=m" >> "$DEFCONFIG"
          
          # LTO Optimization (optional)
          if [ "${{ inputs.enable_lto }}" = "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# Build Optimization" >> "$DEFCONFIG"
            echo "CONFIG_LTO_CLANG_THIN=y" >> "$DEFCONFIG"
            echo "CONFIG_LTO_CLANG=y" >> "$DEFCONFIG"
            echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$DEFCONFIG"
            echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n" >> "$DEFCONFIG"
            echo "CONFIG_OPTIMIZE_INLINING=y" >> "$DEFCONFIG"
          fi
          
          echo "Configuration complete!"
          
          # Add snd-aloop to modules list
          echo "sound/drivers/snd-aloop.ko" >> common/android/gki_aarch64_modules
          
          if [[ -f common/modules.bzl ]]; then
            if [[ "${{ inputs.android_version }}" == "android14" ]] && [[ "${{ inputs.kernel_version }}" == "6.1" ]] && (( ${{ env.SUBLEVEL }} <= 25 )) && [[ "${{ inputs.os_patch_level }}" != "2023-09" ]]; then
              sed -i '/COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
              }' common/modules.bzl
            else
              sed -i '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
              }' common/modules.bzl
            fi
          fi
          
          # ABI bypass
          perl -i -pe 's/^(\s*)return 1$/$1print("Who Cares? Bypassing Now!")\n$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
          
          # Module check bypass
          if [ "${{ inputs.module_bypass }}" = "true" ]; then
            if [[ "${{ inputs.kernel_version }}" == "6.1" ]] || [[ "${{ inputs.kernel_version }}" == "6.6" ]]; then
              TARGET_FILE="common/kernel/module/version.c"
            else
              TARGET_FILE="common/kernel/module.c"
            fi
            
            if [ -f "$TARGET_FILE" ]; then
              sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"
              echo "[OK] Module check bypass applied"
            fi
          fi
      
      - name: Modify Kernel Version
        run: |
          echo "=== Modifying Kernel Version ==="
          cd "${{ env.SOURCE_DIR }}"
          
          sed -i "\$s|echo \"\\\$res\"|echo \"\\\$res-${{ inputs.kernel_name }}\"|" ./common/scripts/setlocalversion
          
          BUILD_TIMESTAMP=$(date -u -d "${{ inputs.build_time }}" +%s 2>/dev/null || echo "1749492000")
          echo "Build timestamp (epoch): $BUILD_TIMESTAMP"
          
          sed -i "s/export SOURCE_DATE_EPOCH=0/export SOURCE_DATE_EPOCH=$BUILD_TIMESTAMP/" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
      
      - name: Build Kernel
        run: |
          echo "=== Building Kernel ==="
          cd "${{ env.SOURCE_DIR }}"
          
          echo "This may take 30-60 minutes..."
          echo "Build started at: $(date)"
          
          tools/bazel build --config=fast --lto=thin //common:kernel_aarch64_dist
          
          echo "Build completed at: $(date)"
      
      - name: Package Kernel
        run: |
          echo "=== Packaging Kernel ==="
          cd "${{ env.SOURCE_DIR }}"
          
          BAZEL_BIN="bazel-bin/common/kernel_aarch64"
          IMAGE_FILE="${BAZEL_BIN}/Image"
          
          if [ ! -f "$IMAGE_FILE" ]; then
            echo "Error: Kernel Image not found!"
            exit 1
          fi
          
          KERNEL_RELEASE=$(cat ${BAZEL_BIN}/include/config/kernel.release | tr '+' '_')
          OUTPUT_IMAGE="Image-${KERNEL_RELEASE}"
          cp "$IMAGE_FILE" "../${OUTPUT_IMAGE}"
          
          cd ..
          if [ ! -d "AnyKernel3" ]; then
            git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
          fi
          
          cp "${OUTPUT_IMAGE}" AnyKernel3/
          cd AnyKernel3
          
          ZIP_NAME="AnyKernel3-${KERNEL_RELEASE}.zip"
          zip -r9 "../${ZIP_NAME}" * -x .git README.md placeholder
          cd ..
          
          echo "IMAGE_FILE=${OUTPUT_IMAGE}" >> $GITHUB_ENV
          echo "ZIP_FILE=${ZIP_NAME}" >> $GITHUB_ENV
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}-${{ github.run_number }}
          name: "GKI ${{ inputs.android_version }} Kernel ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}"
          body: |
            ## GKI Kernel with KernelSU + SUSFS
            
            **Build Information:**
            - Android Version: ${{ inputs.android_version }}
            - Kernel Version: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}
            - OS Patch Level: ${{ inputs.os_patch_level }}
            - Hook Method: ${{ inputs.hook_method }}
            - Module Bypass: ${{ inputs.module_bypass }}
            - BBG Protection: ${{ inputs.enable_bbg }}
            - IPSet Support: ${{ inputs.enable_ipset }}
            - LTO Optimization: ${{ inputs.enable_lto }}
            
            **Installation:**
            1. Flash the AnyKernel3 ZIP in recovery (TWRP/OrangeFox)
            2. Install KernelSU Manager from https://github.com/tiann/KernelSU
            3. Reboot and verify
          draft: false
          prerelease: false
          files: |
            ${{ env.IMAGE_FILE }}
            ${{ env.ZIP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
